// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model synced with Clerk
model User {
  id        String   @id @default(uuid())
  clerkId   String   @unique
  email     String   @unique
  firstName String?
  lastName  String?
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Stripe & Credits
  stripeCustomerId String? @unique
  credits          Int     @default(0)

  documents    UserDocument[]
  interviews   Interview[]
  purchases    Purchase[]
  creditLedger CreditLedger[]

  @@index([clerkId])
  @@index([email])
  @@index([stripeCustomerId])
}

// User documents uploaded to Ragie
model DocumentType {
  id           String   @id @default(uuid())
  visaType     String // e.g., "student", "tourist", "work"
  internalName String // e.g., "ds_160", "i20_form"
  friendlyName String // e.g., "DS-160 Confirmation Page", "I-20 Form"
  description  String? // Optional description or instructions
  isRequired   Boolean  @default(false) // Whether this document is required
  sortOrder    Int      @default(0) // For ordering in UI
  createdAt    DateTime @default(now())

  documents UserDocument[]

  @@unique([visaType, internalName])
  @@index([visaType])
}

model UserDocument {
  id             String   @id @default(uuid())
  userId         String
  clerkId        String // Denormalized for easier querying
  documentTypeId String // Reference to DocumentType
  filename       String
  ragieFileId    String   @unique // Ragie's file ID
  fileSize       Int // Size in bytes
  mimeType       String // e.g., "application/pdf"
  status         String   @default("processing") // "processing", "ready", "failed"
  uploadedAt     DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  documentType DocumentType @relation(fields: [documentTypeId], references: [id], onDelete: Cascade)

  // Only one document per type per user
  @@unique([userId, documentTypeId])
  @@index([userId])
  @@index([clerkId])
  @@index([ragieFileId])
  @@index([documentTypeId])
}

// Interview session tracking
model Interview {
  id        String    @id @default(uuid())
  userId    String
  clerkId   String
  roomName  String    @unique
  visaType  String
  status    String    @default("in_progress") // "in_progress", "completed", "failed"
  startedAt DateTime  @default(now())
  endedAt   DateTime?
  duration  Int? // seconds
  
  // Expiration tracking
  expiresAt              DateTime? // Calculated as startedAt + 7 days
  expirationWarningSent  Boolean   @default(false) // Track if warning email was sent

  // Credits tracking (NEW: Post-interview deduction model)
  creditsPlanned  Int?     // Credits user planned to spend (5/10/15)
  creditsDeducted Int?     // Actual credits deducted (null = not yet processed)
  endedBy         String?  // "user", "agent", "system", "error" - who/what ended the interview
  chargeDecision  String?  // "charged", "not_charged" - AI classification result
  chargeReason    String?  // Human-readable reason for charge decision

  // Recording details
  egressId        String? // LiveKit egress ID
  recordingUrl    String? // S3 URL to MP4 file
  recordingStatus String  @default("pending") // "pending", "recording", "processing", "ready", "failed"

  // Transcription
  transcriptStatus String @default("pending") // "pending", "processing", "ready", "failed"

  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  report             InterviewReport?
  transcriptSegments TranscriptSegment[]

  @@index([userId])
  @@index([clerkId])
  @@index([roomName])
  @@index([expiresAt])
  @@index([expirationWarningSent])
  @@index([creditsDeducted])
}

// Transcript segments from LiveKit transcription
model TranscriptSegment {
  id          String   @id @default(uuid())
  interviewId String
  speaker     String // "agent" or "user"
  text        String   @db.Text
  startTime   Float // seconds from interview start
  endTime     Float // seconds from interview start
  createdAt   DateTime @default(now())

  interview Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)

  @@index([interviewId])
}

// AI-generated interview analysis report
model InterviewReport {
  id          String @id @default(uuid())
  interviewId String @unique

  // Overall assessment
  overallScore   Int // 0-100
  recommendation String // "approve", "deny", "further_review"

  // Detailed analysis (JSON)
  strengths           String @db.Text // JSON array
  weaknesses          String @db.Text // JSON array
  redFlags            String @db.Text // JSON array
  timestampedComments String @db.Text // JSON array with {timestamp, comment, severity}

  // Full AI analysis
  summary     String   @db.Text
  generatedAt DateTime @default(now())

  interview Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)

  @@index([interviewId])
}

// Track all credit purchases from Stripe
model Purchase {
  id                      String   @id @default(uuid())
  userId                  String
  stripePaymentIntentId   String?  @unique // Nullable for free checkouts (100% coupon)
  stripeCheckoutSessionId String   @unique // Primary identifier (always present)
  amount                  Int // Amount in cents (0 for promotional)
  credits                 Int // Credits purchased
  status                  String // "pending", "completed", "failed", "refunded"
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripePaymentIntentId])
  @@index([stripeCheckoutSessionId])
  @@index([createdAt])
}

// Audit trail for all credit changes
model CreditLedger {
  id          String   @id @default(uuid())
  userId      String
  amount      Int // Positive for additions, negative for deductions
  balance     Int // Balance after transaction
  type        String // "purchase", "deduction", "refund", "admin_adjustment"
  description String?
  referenceId String? // Interview ID, Purchase ID, etc.
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([type])
}
